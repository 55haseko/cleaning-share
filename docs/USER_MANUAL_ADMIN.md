# 清掃記録共有システム - 管理者向け運用ガイド

## 目次
1. [はじめに](#はじめに)
2. [管理者の役割と権限](#管理者の役割と権限)
3. [ログインとダッシュボード](#ログインとダッシュボード)
4. [ユーザー管理](#ユーザー管理)
5. [施設管理](#施設管理)
6. [清掃記録の確認と管理](#清掃記録の確認と管理)
7. [領収書管理](#領収書管理)
8. [統計とレポート](#統計とレポート)
9. [データ保持とバックアップ](#データ保持とバックアップ)
10. [トラブルシューティング](#トラブルシューティング)
11. [セキュリティとコンプライアンス](#セキュリティとコンプライアンス)

---

## はじめに

このシステムは、清掃サービスの記録管理とクライアント共有を効率化するための管理システムです。

### システムの特徴
- 📊 リアルタイムで清掃記録を確認
- 👥 ユーザー（スタッフ・クライアント）の一元管理
- 🏢 複数施設の管理
- 📄 領収書の一元管理
- 🔒 役割ベースのアクセス制御（RBAC）
- 🗑️ 自動データ削除機能（写真60日、領収書365日）

---

## 管理者の役割と権限

### 管理者ができること（全権限）

#### ユーザー管理
- ✅ スタッフアカウントの作成・編集・削除
- ✅ クライアントアカウントの作成・編集・削除
- ✅ パスワードのリセット
- ✅ アクセス権限の設定

#### 施設管理
- ✅ 施設の登録・編集・削除
- ✅ 施設とクライアントの紐付け
- ✅ 施設とスタッフの紐付け

#### データ管理
- ✅ 全施設の清掃記録の閲覧
- ✅ 写真の削除
- ✅ 領収書のアップロード・削除
- ✅ 統計データの閲覧

#### システム管理
- ✅ システム設定の変更
- ✅ バックアップとリストア
- ✅ ログの確認

---

## ログインとダッシュボード

### ログイン方法

1. システムURLにアクセス
2. 管理者アカウントでログイン

```
メールアドレス: admin@example.com
パスワード: （管理者パスワード）
```

### ダッシュボード画面

ログイン後、4つのタブが表示されます：

```
┌─────────────────────────────────────────┐
│ [概要] [施設管理] [ユーザー管理] [レポート] │
├─────────────────────────────────────────┤
│ 概要タブの内容                           │
│ - 本日の統計                            │
│ - 最近のアップロード履歴                 │
│ - システム状態                          │
└─────────────────────────────────────────┘
```

#### 📊 概要タブ
- **本日の統計**
  - 今日のアップロード件数
  - 稼働施設数
  - 合計写真数
  - エラー・失敗数

- **最近のアップロード履歴**
  - 施設名
  - 清掃日
  - スタッフ名
  - 写真枚数
  - アップロード日時

#### 🏢 施設管理タブ
- 施設一覧の表示
- 新規施設の登録
- 施設情報の編集
- 施設の削除
- クライアントの紐付け

#### 👥 ユーザー管理タブ
- ユーザー一覧の表示
- 新規ユーザーの作成
- ユーザー情報の編集
- ユーザーの削除
- パスワードのリセット

#### 📈 レポートタブ（今後実装予定）
- 月次レポート
- 稼働率統計
- スタッフ別実績

---

## ユーザー管理

### ユーザーの種類

| 役割 | 権限 | 用途 |
|------|------|------|
| **admin** | 全権限 | システム管理者 |
| **client** | 契約施設の閲覧のみ | お客様（クライアント） |
| **staff** | 担当施設への写真アップロードと閲覧 | 清掃スタッフ |

### 新規ユーザーの作成

1. **[ユーザー管理]** タブをクリック
2. **[新規ユーザー作成]** ボタンをクリック
3. 必要事項を入力：

```
┌─────────────────────────────┐
│ 新規ユーザー作成             │
├─────────────────────────────┤
│ メールアドレス: [________]   │
│ パスワード:     [________]   │
│ 名前:          [________]   │
│ 役割:          [▼ 選択]     │
│   - admin (管理者)          │
│   - client (クライアント)    │
│   - staff (スタッフ)         │
│ 担当施設:      [☐ 施設A]    │
│               [☐ 施設B]    │
│               [☐ 施設C]    │
│                             │
│ [キャンセル] [作成]          │
└─────────────────────────────┘
```

4. **[作成]** ボタンをクリック

### パスワードポリシー

推奨パスワード要件：
- ✅ 8文字以上
- ✅ 英数字を含む
- ✅ 記号を含む（推奨）
- ❌ 誕生日や名前などの推測しやすいものは避ける

### ユーザーの編集

1. ユーザー一覧から編集したいユーザーを選択
2. **[編集]** ボタンをクリック
3. 情報を変更
4. **[保存]** をクリック

### ユーザーの削除

1. ユーザー一覧から削除したいユーザーを選択
2. **[削除]** ボタンをクリック
3. 確認ダイアログで **[削除する]** をクリック

> **⚠️ 警告**
> ユーザーを削除すると、そのユーザーがアップロードした記録も削除される場合があります。削除前に必ずバックアップを取ってください。

### パスワードのリセット

1. ユーザー一覧から対象ユーザーを選択
2. **[パスワードリセット]** ボタンをクリック
3. 新しいパスワードを入力
4. **[リセット]** をクリック
5. 新しいパスワードをユーザーに伝える

---

## 施設管理

### 新規施設の登録

1. **[施設管理]** タブをクリック
2. **[新規施設登録]** ボタンをクリック
3. 施設情報を入力：

```
┌─────────────────────────────┐
│ 新規施設登録                 │
├─────────────────────────────┤
│ 施設名:        [________]    │
│ 住所:          [________]    │
│ クライアント:  [▼ 選択]      │
│                             │
│ [キャンセル] [登録]          │
└─────────────────────────────┘
```

4. **[登録]** ボタンをクリック

### 施設の編集

1. 施設一覧から編集したい施設を選択
2. **[編集]** ボタンをクリック
3. 情報を変更
4. **[保存]** をクリック

### クライアントの紐付け

施設には1つのクライアント（お客様）を紐付けることができます。

**紐付け手順:**
1. 施設の編集画面を開く
2. **クライアント** ドロップダウンから選択
3. **[保存]** をクリック

これにより、そのクライアントはこの施設の清掃記録を閲覧できるようになります。

### スタッフの紐付け

スタッフには複数の施設を担当させることができます。

**紐付け手順:**
1. **[ユーザー管理]** タブを開く
2. スタッフユーザーを編集
3. **担当施設** のチェックボックスで施設を選択
4. **[保存]** をクリック

### 施設の削除

1. 施設一覧から削除したい施設を選択
2. **[削除]** ボタンをクリック
3. 確認ダイアログで **[削除する]** をクリック

> **⚠️ 警告**
> 施設を削除すると、その施設に関連する全ての清掃記録（写真含む）が削除されます。削除前に必ずバックアップを取ってください。

---

## 清掃記録の確認と管理

### 全施設の記録を確認

管理者は全施設の清掃記録を閲覧できます。

1. **[概要]** タブで最近のアップロード履歴を確認
2. または、施設ごとに詳細を確認

### 写真の削除

誤ってアップロードされた写真や、不適切な写真を削除できます。

**削除手順:**
1. 該当施設の清掃記録を開く
2. 削除したい写真を選択
3. **[削除]** ボタンをクリック
4. 確認ダイアログで **[削除する]** をクリック

> **📝 注意**
> 削除した写真は復元できません。削除前に必要に応じてバックアップを取ってください。

---

## 領収書管理

### 領収書のアップロード

1. 施設を選択
2. **[領収書]** タブをクリック
3. **[領収書をアップロード]** ボタンをクリック
4. 月を選択（例: 2025-10）
5. PDFファイルを選択
6. **[アップロード]** をクリック

**対応形式:**
- PDF（推奨）
- JPEG/PNG（画像形式の領収書）

**ファイルサイズ制限:**
- 最大20MB

### 領収書の確認

1. 施設を選択
2. **[領収書]** タブをクリック
3. 月ごとに整理された領収書が表示されます

### 領収書の削除

1. 削除したい領収書の **[削除]** ボタンをクリック
2. 確認ダイアログで **[削除する]** をクリック

---

## 統計とレポート

### 本日の統計

**[概要]** タブで以下の統計を確認できます：

- **今日のアップロード**: 本日アップロードされた清掃記録の件数
- **稼働施設**: 今日清掃が実施された施設数
- **合計写真数**: 本日アップロードされた写真の合計枚数
- **エラー・失敗数**: アップロード失敗やエラーの件数

### 最近のアップロード履歴

直近10件のアップロード履歴が表示されます：

| 施設名 | 清掃日 | スタッフ | 写真数 | アップロード日時 |
|--------|--------|----------|--------|------------------|
| ABCビル | 2025-10-20 | 山田太郎 | 4枚 | 2025-10-20 14:30 |
| XYZ店舗 | 2025-10-20 | 佐藤花子 | 5枚 | 2025-10-20 13:15 |

### 月次レポート（今後実装予定）

- 月ごとの清掃実施回数
- 施設別の稼働率
- スタッフ別の実績

---

## データ保持とバックアップ

### 自動データ削除ポリシー

システムは自動的に古いデータを削除します：

| データ種別 | 保持期間 | 削除タイミング |
|-----------|---------|---------------|
| **清掃写真** | 60日 | 毎日 午前2:00（日本時間） |
| **領収書** | 365日 | 毎日 午前2:00（日本時間） |
| **ユーザーログ** | 90日 | 毎週日曜 午前3:00 |

> **📌 重要**
> 保持期間を過ぎたデータは自動的に削除され、復元できません。必要なデータは定期的にバックアップしてください。

### 保持期間の変更

環境変数で保持期間を変更できます：

**バックエンドの `.env` ファイル:**
```env
RETENTION_DAYS_PHOTO=60        # 写真の保持期間（日）
RETENTION_DAYS_BUNDLE=365      # 領収書の保持期間（日）
```

変更後、サーバーを再起動してください。

### バックアップの推奨手順

#### データベースのバックアップ

**毎日実行（推奨）:**
```bash
# MySQLデータベースのバックアップ
mysqldump -u cleaning_user -p cleaning_system > backup_$(date +%Y%m%d).sql
```

#### 写真ファイルのバックアップ

**毎週実行（推奨）:**
```bash
# アップロードディレクトリをバックアップ
tar -czf uploads_backup_$(date +%Y%m%d).tar.gz /var/www/cleaning-share/backend/uploads
```

#### 自動バックアップスクリプト

cronで自動化することを推奨します：

```bash
# crontabに追加
0 3 * * * /path/to/backup-script.sh
```

### バックアップからの復元

#### データベースの復元

```bash
mysql -u cleaning_user -p cleaning_system < backup_20251020.sql
```

#### 写真ファイルの復元

```bash
tar -xzf uploads_backup_20251020.tar.gz -C /
```

---

## トラブルシューティング

### 問題1: スタッフが写真をアップロードできない

**確認項目:**

1. **スタッフのアカウント状態**
   - アカウントが有効か
   - 施設が正しく紐付けられているか

2. **施設の設定**
   - 施設が正しく登録されているか

3. **サーバーの状態**
   - バックエンドサーバーが起動しているか
   - ディスク容量は十分か

**確認コマンド（サーバー側）:**
```bash
# サーバーの状態確認
pm2 status

# ディスク容量確認
df -h

# ログの確認
pm2 logs backend --lines 50
```

### 問題2: クライアントが写真を見られない

**確認項目:**

1. **クライアントと施設の紐付け**
   - 施設に正しいクライアントが紐付けられているか

2. **写真の保持期間**
   - 60日を過ぎて削除されていないか

3. **ブラウザのキャッシュ**
   - クライアントにキャッシュクリアを指示

### 問題3: 統計データが表示されない

**原因と対処:**

1. **データベース接続エラー**
   ```bash
   # データベース接続確認
   mysql -u cleaning_user -p
   ```

2. **APIエラー**
   ```bash
   # ログでエラー確認
   pm2 logs backend --err
   ```

3. **ブラウザのコンソールエラー**
   - F12キーでデベロッパーツールを開く
   - Consoleタブでエラー確認

### 問題4: 領収書がアップロードできない

**確認項目:**

1. **ファイルサイズ**
   - 20MBを超えていないか

2. **ファイル形式**
   - PDFまたはJPEG/PNG形式か

3. **ストレージ容量**
   ```bash
   df -h /var/www/cleaning-share/backend/uploads
   ```

### 問題5: システムが遅い

**対処法:**

1. **データベースの最適化**
   ```bash
   mysqlcheck -u cleaning_user -p --optimize cleaning_system
   ```

2. **古いログの削除**
   ```bash
   pm2 flush
   ```

3. **サーバーリソースの確認**
   ```bash
   # CPU・メモリ使用率確認
   top
   ```

---

## セキュリティとコンプライアンス

### パスワード管理

#### 管理者パスワードの変更

**定期的な変更（3ヶ月ごと推奨）:**

1. 右上のユーザーメニューから **[設定]** を選択
2. **[パスワード変更]** をクリック
3. 現在のパスワードと新しいパスワードを入力
4. **[変更]** をクリック

#### 強固なパスワードの例
```
良い例: Kz9#mP2@vN8!qR5
悪い例: password123, admin2024
```

### アクセスログの確認

システムは全てのログイン・操作ログを記録しています。

**ログの確認（サーバー側）:**
```bash
# アクセスログ
pm2 logs backend | grep "login"

# エラーログ
pm2 logs backend --err
```

### 不正アクセス対策

#### ログイン試行回数制限

システムは自動的に以下の保護機能を実装しています：

- **5回連続失敗**: 30分間ログイン禁止
- **10回連続失敗**: IPアドレスをブロック

#### 不審なアクセスの検出

定期的にログを確認してください：

```bash
# 最近のログイン失敗
pm2 logs backend | grep "ログイン失敗"
```

### GDPR / プライバシー対応

#### 個人情報の取り扱い

システムが保存する個人情報：
- ユーザーのメールアドレス
- ユーザーの名前
- ログイン履歴
- 清掃写真（位置情報は自動削除）

#### データ削除リクエストへの対応

ユーザーから削除リクエストがあった場合：

1. **ユーザー削除**
   - [ユーザー管理] → 該当ユーザーを削除

2. **データベースから完全削除（必要に応じて）**
   ```sql
   -- ユーザーと関連データの削除
   DELETE FROM users WHERE id = ?;
   DELETE FROM cleaning_sessions WHERE staff_user_id = ?;
   ```

### SSL/TLS証明書の更新

**Let's Encryptの場合:**
```bash
# 証明書の自動更新確認
certbot renew --dry-run

# 手動更新
certbot renew
systemctl reload nginx
```

---

## 定期メンテナンスチェックリスト

### 毎日
- [ ] システムが正常に稼働しているか確認
- [ ] エラーログを確認
- [ ] バックアップが正常に実行されたか確認

### 毎週
- [ ] ディスク使用量を確認
- [ ] データベースの最適化
- [ ] アクセスログの確認

### 毎月
- [ ] 不要なデータの削除
- [ ] セキュリティアップデートの適用
- [ ] バックアップの復元テスト

### 3ヶ月ごと
- [ ] 管理者パスワードの変更
- [ ] ユーザーアカウントの棚卸し
- [ ] システムパフォーマンスの評価

---

## システム設定

### 環境変数（.env）

重要な設定項目：

```env
# データベース
DB_HOST=localhost
DB_USER=cleaning_user
DB_PASSWORD=strongpassword
DB_NAME=cleaning_system

# サーバー
PORT=4001
NODE_ENV=production

# セキュリティ
JWT_SECRET=（64文字以上のランダム文字列）

# CORS（フロントエンドのURL）
CORS_ORIGIN=https://your-domain.com

# ストレージ
STORAGE_ROOT=/var/www/cleaning-share/backend/uploads

# データ保持
RETENTION_DAYS_PHOTO=60
RETENTION_DAYS_BUNDLE=365

# ファイルサイズ
MAX_FILE_MB=20
```

### 設定変更後の再起動

```bash
pm2 restart backend
```

---

## お問い合わせ・サポート

### 技術サポート

```
メール: tech-support@cleaning-system.com
電話: 03-XXXX-XXXX（平日 9:00-18:00）
緊急時: 080-XXXX-XXXX（24時間対応）
```

### システム開発元

```
会社名: 株式会社〇〇
担当: システム開発部
メール: dev@company.com
```

---

## 改訂履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-10-20 | 1.0 | 初版作成 |

---

**© 2025 清掃記録共有システム**

*本マニュアルは管理者専用です。外部への開示は禁止されています。*
